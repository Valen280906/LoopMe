<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LoopMe</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="../css/public.css">
    <style>
        .stat-card {
            transition: transform 0.3s;
            border-radius: 10px;
            color: white;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-store"></i> LoopMe Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="productos.html">
                            <i class="fas fa-tshirt"></i> Productos e Inventario
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="pedidos.html">
                            <i class="fas fa-shopping-cart"></i> Pedidos
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="reportes.html">
                            <i class="fas fa-chart-bar"></i> Reportes
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="fas fa-users"></i> Usuarios
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container-fluid mt-4">
        <!-- Bienvenida -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Bienvenido, <span id="welcomeName"></span></h4>
                        <p class="card-text">
                            <span id="welcomeMessage"></span>
                            <br>
                            <small class="text-muted" id="lastLogin"></small>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card bg-primary p-3 text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 id="totalProductos">0</h2>
                            <p class="mb-0">Productos</p>
                        </div>
                        <i class="fas fa-tshirt stat-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-success p-3 text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 id="totalVentas">0</h2>
                            <p class="mb-0">Ventas Hoy</p>
                        </div>
                        <i class="fas fa-shopping-cart stat-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-warning p-3 text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 id="stockBajo">0</h2>
                            <p class="mb-0">Stock Bajo</p>
                        </div>
                        <i class="fas fa-exclamation-triangle stat-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-info p-3 text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 id="totalClientes">0</h2>
                            <p class="mb-0">Clientes</p>
                        </div>
                        <i class="fas fa-users stat-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos y contenido adicional -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-chart-line me-2"></i>Ventas de la Semana
                    </div>
                    <div class="card-body">
                        <canvas id="ventasChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-bell me-2"></i>Alertas Recientes
                    </div>
                    <div class="card-body" id="alertsContainer">
                        <div class="alert alert-warning" role="alert" id="lowStockAlert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Stock bajo:</strong> Cargando...
                        </div>
                        <div class="alert alert-danger" role="alert" id="outOfStockAlert">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>Producto agotado:</strong> Cargando...
                        </div>
                        <div class="alert alert-info" role="alert" id="newOrdersAlert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Nuevo pedido:</strong> Cargando...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <a href="productos.html" class="btn btn-primary w-100">
                                    <i class="fas fa-plus me-2"></i>Nuevo Producto
                                </a>
                            </div>
                            <div class="col-md-3 mb-2">
                                <a href="pedidos.html" class="btn btn-success w-100">
                                    <i class="fas fa-cash-register me-2"></i>Registrar Venta
                                </a>
                            </div>

                            <div class="col-md-3 mb-2">
                                <a href="users.html" class="btn btn-info w-100">
                                    <i class="fas fa-user-plus me-2"></i>Agregar Usuario
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let usuario = null;
        let token = null;

        // Verificar autenticación al cargar
        window.onload = function () {
            verificarAutenticacion();
            cargarEstadisticas();
            cargarAlertas();
            inicializarGrafico();
        };

        // Verificar si el usuario está autenticado
        function verificarAutenticacion() {
            token = localStorage.getItem("token");
            const userData = localStorage.getItem("user");

            if (!token || !userData) {
                window.location.href = "login.html";
                return;
            }

            usuario = JSON.parse(userData);

            // Mostrar información del usuario
            document.getElementById("userName").textContent = usuario.nombre;
            document.getElementById("welcomeName").textContent = usuario.nombre;

            // Mensaje personalizado según rol
            const mensajes = {
                'Administrador': 'Tienes acceso completo al sistema.'
            };

            document.getElementById("welcomeMessage").textContent =
                `Rol: ${usuario.rol}. ${mensajes[usuario.rol] || ''}`;

            // Mostrar última conexión
            const ahora = new Date();
            document.getElementById("lastLogin").textContent =
                `Última conexión: ${ahora.toLocaleDateString()} ${ahora.toLocaleTimeString()}`;
        }

        // Cerrar sesión
        function logout() {
            Swal.fire({
                title: '¿Cerrar sesión?',
                text: "¿Estás seguro que deseas salir del sistema?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cerrar sesión',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem("token");
                    localStorage.removeItem("user");
                    window.location.href = "login.html";
                }
            });
        }

        // Cargar estadísticas
        function cargarEstadisticas() {
            fetch("http://localhost:3000/api/reports/dashboard-stats", {
                headers: { "Authorization": `Bearer ${token}` }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.stats;
                        document.getElementById("totalProductos").textContent = stats.totalProductos;
                        document.getElementById("totalVentas").textContent = `$${parseFloat(stats.ventasHoy).toFixed(2)}`;
                        document.getElementById("stockBajo").textContent = stats.stockBajo;
                        document.getElementById("totalClientes").textContent = stats.totalClientes;
                    }
                })
                .catch(err => console.error("Error cargando estadísticas:", err));
        }

        // Inicializar gráfico de ventas
        function inicializarGrafico() {
            const ctx = document.getElementById('ventasChart').getContext('2d');

            fetch("http://localhost:3000/api/reports/sales-chart", {
                headers: { "Authorization": `Bearer ${token}` }
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) return;

                    const chartData = data.chartData;
                    const labels = chartData.map(d => d.fecha);
                    const values = chartData.map(d => d.total);

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Ventas ($)',
                                data: values,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: true } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { callback: function (value) { return '$' + value; } }
                                }
                            }
                        }
                    });
                })
                .catch(err => console.error("Error cargando gráfico:", err));
        }

        // Cargar alertas recientes (Dinamismo solicitado)
        function cargarAlertas() {
            fetch("http://localhost:3000/api/reports/recent-alerts", {
                headers: { "Authorization": `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const { lowStock, outOfStock, newOrdersCount } = data.alerts;
                    console.log("[DEBUG ALERTS] Low Stock:", lowStock);
                    console.log("[DEBUG ALERTS] Out of Stock:", outOfStock);
                    console.log("[DEBUG ALERTS] New Orders:", newOrdersCount);
                    
                    // Stock Bajo
                    const lowStockEl = document.getElementById("lowStockAlert");
                    if (lowStock.length > 0) {
                        const items = lowStock.map(p => `${p.nombre} (${p.stock_actual})`).join(", ");
                        lowStockEl.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i><strong>Stock bajo:</strong> ${items}`;
                        lowStockEl.className = "alert alert-warning";
                    } else {
                        lowStockEl.innerHTML = `<i class="fas fa-check-circle me-2"></i><strong>Stock bajo:</strong> Todo al día`;
                        lowStockEl.className = "alert alert-success";
                    }

                    // Agotados
                    const outOfStockEl = document.getElementById("outOfStockAlert");
                    if (outOfStock.length > 0) {
                        const items = outOfStock.map(p => p.nombre).join(", ");
                        outOfStockEl.innerHTML = `<i class="fas fa-times-circle me-2"></i><strong>Agotado:</strong> ${items}`;
                        outOfStockEl.style.display = "block";
                    } else {
                        outOfStockEl.style.display = "none";
                    }

                    // Nuevos Pedidos
                    const newOrdersEl = document.getElementById("newOrdersAlert");
                    if (newOrdersCount > 0) {
                        newOrdersEl.innerHTML = `<i class="fas fa-shopping-bag me-2"></i><strong>Nuevos pedidos:</strong> ${newOrdersCount} hoy`;
                        newOrdersEl.className = "alert alert-info bounce-alert";
                    } else {
                        newOrdersEl.innerHTML = `<i class="fas fa-info-circle me-2"></i><strong>Pedidos:</strong> Sin novedades hoy`;
                        newOrdersEl.className = "alert alert-light border";
                    }
                }
            })
            .catch(err => console.error("Error cargando alertas:", err));
        }

        // Actualizar datos cada 30 segundos
        setInterval(() => {
            cargarEstadisticas();
            cargarAlertas();
        }, 30000);
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos - LoopMe</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-store"></i> LoopMe Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="productos.html">
                            <i class="fas fa-tshirt"></i> Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="inventario.html">
                            <i class="fas fa-boxes"></i> Inventario
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="pedidos.html">
                            <i class="fas fa-shopping-cart"></i> Pedidos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="fas fa-users"></i> Usuarios
                        </a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-tshirt me-2"></i>Gestión de Productos
                            <button class="btn btn-light btn-sm float-end" onclick="mostrarModalProducto()">
                                <i class="fas fa-plus"></i> Nuevo Producto
                            </button>
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" id="buscarProducto" class="form-control" placeholder="Buscar producto...">
                            </div>
                            <div class="col-md-3">
                                <select id="filtroCategoria" class="form-control">
                                    <option value="">Todas las categorías</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-secondary w-100" onclick="cargarProductos()">
                                    <i class="fas fa-sync"></i> Actualizar
                                </button>
                            </div>
                        </div>

                        <!-- Tabla de productos -->
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Imagen</th>
                                        <th>Nombre</th>
                                        <th>Categoría</th>
                                        <th>Precio</th>
                                        <th>Stock</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaProductos">
                                    <!-- Los productos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar producto -->
    <div class="modal fade" id="modalProducto" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProducto">
                        <input type="hidden" id="productoId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" id="nombre" class="form-control" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Descripción</label>
                                    <textarea id="descripcion" class="form-control" rows="3"></textarea>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Precio ($) *</label>
                                            <input type="number" id="precio" class="form-control" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Talla</label>
                                            <input type="text" id="talla" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Color</label>
                                    <input type="text" id="color" class="form-control">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Categoría</label>
                                    <select id="categoria_id" class="form-control">
                                        <option value="">Seleccionar categoría</option>
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Stock Actual</label>
                                            <input type="number" id="stock_actual" class="form-control" min="0" value="0">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Stock Mínimo</label>
                                            <input type="number" id="stock_minimo" class="form-control" min="1" value="5">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Imagen del Producto</label>
                                    <input type="file" id="imagen_file" class="form-control" accept="image/*">
                                    <small class="text-muted">Formatos aceptados: JPG, PNG, GIF, WebP (Máx. 5MB)</small>
                                    <input type="hidden" id="imagen_url" value="">
                                    <div id="imagen_preview" class="mt-2" style="max-width: 200px;"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarProducto()">
                        <i class="fas fa-save"></i> Guardar Producto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let usuario = null;
        let token = null;
        let productos = [];
        let categorias = [];

        // Verificar autenticación al cargar
        window.onload = function() {
            verificarAutenticacion();
            cargarCategorias();
            cargarProductos();
        };

        // Verificar si el usuario está autenticado
        function verificarAutenticacion() {
            token = localStorage.getItem("token");
            const userData = localStorage.getItem("user");
            
            if (!token || !userData) {
                window.location.href = "login.html";
                return;
            }
            
            usuario = JSON.parse(userData);
            
            // Verificar token con el servidor
            fetch("http://localhost:3000/api/auth/verify", {
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    localStorage.removeItem("token");
                    localStorage.removeItem("user");
                    window.location.href = "login.html";
                }
            })
            .catch(error => {
                console.error("Error:", error);
                window.location.href = "login.html";
            });
        }

        // Previsualización de imagen
        document.getElementById('imagen_file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagen_preview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="max-width: 200px;">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        });

        // Cerrar sesión
        function logout() {
            if (confirm("¿Está seguro de cerrar sesión?")) {
                localStorage.removeItem("token");
                localStorage.removeItem("user");
                window.location.href = "login.html";
            }
        }

        // Cargar categorías
        function cargarCategorias() {
            fetch("http://localhost:3000/api/categories")
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.categorias) {
                        categorias = data.categorias;
                        const select = document.getElementById("categoria_id");
                        const filtro = document.getElementById("filtroCategoria");
                        
                        let options = '<option value="">Seleccionar categoría</option>';
                        let filtroOptions = '<option value="">Todas las categorías</option>';
                        
                        categorias.forEach(categoria => {
                            options += `<option value="${categoria.id}">${categoria.nombre}</option>`;
                            filtroOptions += `<option value="${categoria.id}">${categoria.nombre}</option>`;
                        });
                        
                        select.innerHTML = options;
                        filtro.innerHTML = filtroOptions;
                    }
                })
                .catch(error => console.error("Error cargando categorías:", error));
        }

        // Cargar productos
        function cargarProductos() {
            fetch("http://localhost:3000/api/products")
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.productos) {
                        productos = data.productos;
                        mostrarProductos(productos);
                    } else {
                        document.getElementById("tablaProductos").innerHTML = 
                            `<tr><td colspan="8" class="text-center">No hay productos registrados</td></tr>`;
                    }
                })
                .catch(error => {
                    console.error("Error cargando productos:", error);
                    document.getElementById("tablaProductos").innerHTML = 
                        `<tr><td colspan="8" class="text-center text-danger">Error al cargar productos</td></tr>`;
                });
        }

        // Mostrar productos en la tabla
        function mostrarProductos(listaProductos) {
            const tbody = document.getElementById("tablaProductos");
            // Permisos: quién puede editar o eliminar
            const puedeEditar = usuario.rol === 'Administrador' || usuario.rol === 'Inventario';
            const puedeEliminar = usuario.rol === 'Administrador';

            if (listaProductos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center">No hay productos que coincidan</td></tr>`;
                return;
            }
            
            let html = "";
            
            listaProductos.forEach(producto => {
                const estado = producto.stock_bajo ? 
                    '<span class="badge bg-warning">Stock Bajo</span>' : 
                    (producto.stock_actual > 0 ? 
                        '<span class="badge bg-success">Disponible</span>' : 
                        '<span class="badge bg-danger">Agotado</span>');
                
                const imagen = producto.imagen_url ? 
                    `<img src="${producto.imagen_url}" alt="${producto.nombre}" class="img-thumbnail" style="width: 50px; height: 50px;">` :
                    `<div class="img-thumbnail d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; background: #eee;">
                        <i class="fas fa-tshirt text-muted"></i>
                    </div>`;
                
                html += `
                    <tr>
                        <td>${producto.id}</td>
                        <td>${imagen}</td>
                        <td>
                            <strong>${producto.nombre}</strong><br>
                            <small class="text-muted">${producto.descripcion?.substring(0, 50) || 'Sin descripción'}...</small>
                        </td>
                        <td>${producto.categoria || 'Sin categoría'}</td>
                        <td>$${parseFloat(producto.precio).toFixed(2)}</td>
                        <td>
                            <span class="${producto.stock_actual < producto.stock_minimo ? 'text-warning fw-bold' : ''}">
                                ${producto.stock_actual}
                            </span>
                            <small class="text-muted d-block">Mín: ${producto.stock_minimo}</small>
                        </td>
                        <td>${estado}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editarProducto(${producto.id})" 
                                        ${!puedeEditar ? 'disabled' : ''}>
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="eliminarProducto(${producto.id})"
                                        ${!puedeEliminar ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="verDetalles(${producto.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Mostrar modal para nuevo producto
        function mostrarModalProducto(editar = false) {
            if (usuario.rol !== 'Administrador') {
                alert('Solo los administradores pueden crear productos');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalProducto'));
            const titulo = document.getElementById('modalTitulo');
            const form = document.getElementById('formProducto');
            
            if (!editar) {
                titulo.textContent = 'Nuevo Producto';
                form.reset();
                document.getElementById('productoId').value = '';
                document.getElementById('stock_actual').value = '0';
                document.getElementById('stock_minimo').value = '5';
            }
            
            modal.show();
        }

        // Guardar producto (crear o actualizar)
        function guardarProducto() {
            const productoId = document.getElementById('productoId').value;
            const datos = {
                nombre: document.getElementById('nombre').value,
                descripcion: document.getElementById('descripcion').value,
                precio: parseFloat(document.getElementById('precio').value),
                talla: document.getElementById('talla').value,
                color: document.getElementById('color').value,
                categoria_id: document.getElementById('categoria_id').value || null,
                imagen_url: document.getElementById('imagen_url').value || null,
                stock_actual: parseInt(document.getElementById('stock_actual').value) || 0,
                stock_minimo: parseInt(document.getElementById('stock_minimo').value) || 5
            };
            
            // Validaciones básicas
            if (!datos.nombre || !datos.precio) {
                alert('Nombre y precio son obligatorios');
                return;
            }
            
            const url = productoId ? 
                `http://localhost:3000/api/admin/products/${productoId}` : 
                'http://localhost:3000/api/admin/products';
            
            const metodo = productoId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: metodo,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(datos)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    cargarProductos();
                    bootstrap.Modal.getInstance(document.getElementById('modalProducto')).hide();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar el producto');
            });
        }

        // Editar producto
        function editarProducto(id) {
            if (usuario.rol !== 'Administrador') {
                alert('Solo los administradores pueden editar productos');
                return;
            }
            
            fetch(`http://localhost:3000/api/products/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.producto) {
                        const producto = data.producto;
                        
                        document.getElementById('modalTitulo').textContent = 'Editar Producto';
                        document.getElementById('productoId').value = producto.id;
                        document.getElementById('nombre').value = producto.nombre;
                        document.getElementById('descripcion').value = producto.descripcion || '';
                        document.getElementById('precio').value = producto.precio;
                        document.getElementById('talla').value = producto.talla || '';
                        document.getElementById('color').value = producto.color || '';
                        document.getElementById('categoria_id').value = producto.categoria_id || '';
                        document.getElementById('stock_actual').value = producto.stock_actual;
                        document.getElementById('stock_minimo').value = producto.stock_minimo;
                        document.getElementById('imagen_url').value = producto.imagen_url || '';
                        
                        const modal = new bootstrap.Modal(document.getElementById('modalProducto'));
                        modal.show();
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Eliminar producto (desactivar)
        function eliminarProducto(id) {
            if (usuario.rol !== 'Administrador') {
                alert('Solo los administradores pueden eliminar productos');
                return;
            }
            
            if (!confirm('¿Está seguro de eliminar este producto? Se desactivará pero no se borrarán los registros.')) {
                return;
            }
            
            fetch(`http://localhost:3000/api/admin/products/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    cargarProductos();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar el producto');
            });
        }

        // Ver detalles del producto
        function verDetalles(id) {
            // Podrías abrir un modal con más detalles
            alert(`Ver detalles del producto ID: ${id}\nEsta función se implementará más adelante.`);
        }

        // Filtrar productos
        document.getElementById('buscarProducto').addEventListener('input', function(e) {
            const texto = e.target.value.toLowerCase();
            const categoriaId = document.getElementById('filtroCategoria').value;
            
            const filtrados = productos.filter(producto => {
                const coincideTexto = producto.nombre.toLowerCase().includes(texto) || 
                                     (producto.descripcion && producto.descripcion.toLowerCase().includes(texto));
                const coincideCategoria = !categoriaId || producto.categoria_id == categoriaId;
                
                return coincideTexto && coincideCategoria;
            });
            
            mostrarProductos(filtrados);
        });
        
        document.getElementById('filtroCategoria').addEventListener('change', function() {
            document.getElementById('buscarProducto').dispatchEvent(new Event('input'));
        });
    </script>
</body>
</html>
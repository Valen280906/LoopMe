<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producto - LoopMe</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Estilos globales LoopMe -->
    <link rel="stylesheet" href="css/public.css">
    <style>
        .product-detail-container {
            margin-top: 40px;
            margin-bottom: 60px;
        }
        
        .product-image-main {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            background: #f8f9fa;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .product-image-main img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-height: 100%;
        }
        
        .product-thumbnails {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .thumbnail-item {
            width: 80px;
            height: 80px;
            border: 2px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .thumbnail-item:hover,
        .thumbnail-item.active {
            border-color: var(--primary-color);
        }
        
        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-info-detail {
            padding-left: 40px;
        }
        
        .product-title-detail {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 15px;
        }
        
        .product-price-detail {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .product-meta-detail {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
        }
        
        .meta-item {
            display: flex;
            margin-bottom: 10px;
        }
        
        .meta-label {
            font-weight: 600;
            min-width: 120px;
            color: var(--dark-color);
        }
        
        .meta-value {
            flex: 1;
        }
        
        .stock-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .stock-available {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        
        .stock-low {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
        
        .stock-out {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e0e0e0;
            background: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .quantity-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .quantity-input {
            width: 60px;
            height: 40px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-left: none;
            border-right: none;
            font-weight: 600;
        }
        
        .product-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .product-description {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 40px;
        }
        
        .description-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-color);
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .breadcrumb-loopme {
            background: transparent;
            padding: 0;
            margin-bottom: 30px;
        }
        
        .breadcrumb-loopme .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .breadcrumb-loopme .breadcrumb-item.active {
            color: var(--dark-color);
        }
        
        .related-products {
            margin-top: 60px;
            margin-bottom: 60px;
        }
        
        .back-to-store {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-loopme">
        <div class="container">
            <a class="navbar-brand navbar-brand-loopme" href="index.html">
                <i class="fas fa-tshirt"></i> LoopMe
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarLoopMe">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarLoopMe">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme" href="index.html">
                            <i class="fas fa-home"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme" href="tienda.html">
                            <i class="fas fa-store"></i> Tienda
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme" href="carrito.html">
                            <i class="fas fa-shopping-cart"></i> Carrito
                            <span class="badge bg-light text-primary ms-1" id="cartCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme" href="pedidos.html">
                            <i class="fas fa-clipboard-list"></i> Mis Pedidos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme" href="#" id="loginLink">
                            <i class="fas fa-user"></i> Mi Cuenta
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container">
        <nav aria-label="breadcrumb" class="breadcrumb-loopme">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="tienda.html">Tienda</a></li>
                <li class="breadcrumb-item active" id="breadcrumbCategory">Producto</li>
            </ol>
        </nav>
        
        <div class="back-to-store">
            <a href="tienda.html" class="btn btn-loopme-outline">
                <i class="fas fa-arrow-left me-2"></i> Volver a la tienda
            </a>
        </div>
    </div>

    <!-- Detalle del producto -->
    <div class="container product-detail-container">
        <div class="row">
            <!-- Columna de imágenes -->
            <div class="col-lg-6">
                <div class="product-image-main" id="mainImageContainer">
                    <div class="text-center text-muted py-5" id="loadingImage">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando imagen...</p>
                    </div>
                </div>
                <div class="product-thumbnails" id="thumbnailContainer">
                    <!-- Miniaturas se cargarán aquí -->
                </div>
            </div>
            
            <!-- Columna de información -->
            <div class="col-lg-6">
                <div class="product-info-detail">
                    <h1 class="product-title-detail" id="productTitle">Cargando...</h1>
                    
                    <div class="product-price-detail" id="productPrice">
                        $0.00
                    </div>
                    
                    <div class="product-meta-detail">
                        <div class="meta-item">
                            <span class="meta-label">Categoría:</span>
                            <span class="meta-value" id="productCategory">Cargando...</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Talla:</span>
                            <span class="meta-value" id="productTalla">No especificada</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Color:</span>
                            <span class="meta-value" id="productColor">No especificado</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Disponibilidad:</span>
                            <span class="meta-value">
                                <span id="productStockBadge" class="stock-badge stock-available">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                                <span id="productStockText" class="ms-2">Verificando stock...</span>
                            </span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">SKU:</span>
                            <span class="meta-value" id="productSKU">#00000</span>
                        </div>
                    </div>
                    
                    <!-- Selector de cantidad -->
                    <div class="quantity-selector">
                        <label class="me-3 fw-bold">Cantidad:</label>
                        <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                        <input type="number" class="quantity-input" id="productQuantity" value="1" min="1" max="10">
                        <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                        <span class="ms-3 text-muted" id="maxStockText">(Máx: 10)</span>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="product-actions">
                        <button class="btn btn-loopme btn-lg flex-grow-1" id="addToCartBtn" onclick="addToCart()">
                            <i class="fas fa-cart-plus me-2"></i> Agregar al Carrito
                        </button>
                        <button class="btn btn-loopme-outline btn-lg" id="buyNowBtn" onclick="buyNow()">
                            <i class="fas fa-bolt me-2"></i> Comprar Ahora
                        </button>
                    </div>
                    
                    <!-- Mensajes de estado -->
                    <div id="cartMessage" class="alert d-none mt-3"></div>
                    
                    <!-- Opciones adicionales -->
                    <div class="mt-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addGiftWrap">
                            <label class="form-check-label" for="addGiftWrap">
                                Agregar empaque para regalo (+$5.00)
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="saveForLater">
                            <label class="form-check-label" for="saveForLater">
                                Guardar en mi lista de deseos
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Descripción del producto -->
        <div class="product-description">
            <h3 class="description-title">Descripción del Producto</h3>
            <div id="productDescription">
                <p>Cargando descripción del producto...</p>
            </div>
        </div>
        
        <!-- Productos relacionados -->
        <div class="related-products">
            <div class="section-title">
                <h2>PRODUCTOS RELACIONADOS</h2>
                <p>Quizás también te interesen estos productos</p>
            </div>
            <div class="row" id="relatedProductsContainer">
                <!-- Productos relacionados se cargarán aquí -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="loopme-footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="footer-logo">
                        <i class="fas fa-tshirt me-2"></i>LoopMe
                    </div>
                    <p>Tu tienda de moda online con las mejores prendas y accesorios para hombre y mujer.</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-pinterest"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 mb-4">
                    <div class="footer-links">
                        <h5>Comprar</h5>
                        <ul>
                            <li><a href="#">Mujer</a></li>
                            <li><a href="#">Hombre</a></li>
                            <li><a href="#">Niños</a></li>
                            <li><a href="#">Ofertas</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 mb-4">
                    <div class="footer-links">
                        <h5>Información</h5>
                        <ul>
                            <li><a href="#">Sobre Nosotros</a></li>
                            <li><a href="#">Contacto</a></li>
                            <li><a href="#">Políticas</a></li>
                            <li><a href="#">Términos</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 mb-4">
                    <div class="footer-links">
                        <h5>Contacto</h5>
                        <ul>
                            <li><i class="fas fa-map-marker-alt me-2"></i> Caracas, Venezuela</li>
                            <li><i class="fas fa-phone me-2"></i> +58 412-1234567</li>
                            <li><i class="fas fa-envelope me-2"></i> info@loopme.com</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 LoopMe Tienda de Ropa. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let productoActual = null;
        let relatedProducts = [];
        let currentQuantity = 1;
        let maxQuantity = 10;
        let cartCount = 0;

        // Cargar producto al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacion();
            actualizarContadorCarrito();
            cargarProductoDesdeURL();
        });

        // Verificar autenticación
        function verificarAutenticacion() {
            const token = localStorage.getItem("cliente_token");
            const clienteInfo = localStorage.getItem("cliente_info");
            const loginLink = document.getElementById("loginLink");
            
            if (token && clienteInfo) {
                try {
                    const cliente = JSON.parse(clienteInfo);
                    loginLink.innerHTML = `<i class="fas fa-user me-1"></i> ${cliente.nombre.split(' ')[0]}`;
                    loginLink.href = "javascript:void(0)";
                    
                    loginLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        mostrarMenuUsuario();
                    });
                } catch(e) {
                    loginLink.innerHTML = '<i class="fas fa-user"></i> Mi Cuenta';
                    loginLink.href = "login-cliente.html";
                }
            } else {
                loginLink.innerHTML = '<i class="fas fa-user"></i> Mi Cuenta';
                loginLink.href = "login-cliente.html";
            }
        }

        // Menú desplegable para usuario autenticado
        function mostrarMenuUsuario() {
            const cliente = JSON.parse(localStorage.getItem("cliente_info"));
            const menuHTML = `
                <div class="dropdown-menu show" style="position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate(0px, 40px);">
                    <div class="dropdown-header">
                        <strong>${cliente.nombre}</strong>
                        <p class="mb-0 text-muted small">${cliente.email}</p>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="pedidos.html">
                        <i class="fas fa-clipboard-list me-2"></i>Mis Pedidos
                    </a>
                    <a class="dropdown-item" href="#">
                        <i class="fas fa-heart me-2"></i>Favoritos
                    </a>
                    <a class="dropdown-item" href="#">
                        <i class="fas fa-user-edit me-2"></i>Mi Perfil
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-danger" href="#" onclick="logoutCliente()">
                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                    </a>
                </div>
            `;
            
            const loginLink = document.getElementById("loginLink");
            let dropdownMenu = loginLink.nextElementSibling;
            
            if (!dropdownMenu || !dropdownMenu.classList.contains("dropdown-menu")) {
                dropdownMenu = document.createElement("div");
                dropdownMenu.className = "dropdown-menu";
                loginLink.parentElement.appendChild(dropdownMenu);
            }
            
            dropdownMenu.innerHTML = menuHTML;
            dropdownMenu.classList.add("show");
            
            document.addEventListener('click', function closeMenu(e) {
                if (!loginLink.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove("show");
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // Cerrar sesión
        function logoutCliente() {
            if (confirm("¿Estás seguro de cerrar sesión?")) {
                localStorage.removeItem("cliente_token");
                localStorage.removeItem("cliente_info");
                window.location.href = "tienda.html";
            }
        }

        // Obtener ID del producto desde la URL
        function getProductIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Cargar producto desde la API
        function cargarProductoDesdeURL() {
            const productId = getProductIdFromURL();
            
            if (!productId) {
                mostrarError("Producto no encontrado");
                return;
            }
            
            // Mostrar loading
            document.getElementById("loadingImage").style.display = "block";
            
            fetch(`http://localhost:3000/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Producto no encontrado');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.producto) {
                        productoActual = data.producto;
                        mostrarProductoDetalle();
                        cargarProductosRelacionados();
                    } else {
                        mostrarError("Producto no encontrado");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    mostrarError("Error al cargar el producto");
                });
        }

        // Mostrar detalles del producto
        function mostrarProductoDetalle() {
            if (!productoActual) return;
            
            // Actualizar título de la página
            document.title = `${productoActual.nombre} - LoopMe`;
            
            // Actualizar breadcrumb
            document.getElementById("breadcrumbCategory").textContent = productoActual.categoria || "Producto";
            
            // Actualizar información básica
            document.getElementById("productTitle").textContent = productoActual.nombre;
            document.getElementById("productPrice").textContent = `$${parseFloat(productoActual.precio).toFixed(2)}`;
            document.getElementById("productCategory").textContent = productoActual.categoria || "Sin categoría";
            document.getElementById("productTalla").textContent = productoActual.talla || "No especificada";
            document.getElementById("productColor").textContent = productoActual.color || "No especificado";
            document.getElementById("productSKU").textContent = `#${productoActual.id.toString().padStart(5, '0')}`;
            
            // Actualizar descripción
            const descripcion = productoActual.descripcion || "Este producto no tiene descripción disponible.";
            document.getElementById("productDescription").innerHTML = `
                <p>${descripcion}</p>
                <p class="mt-3">
                    <strong>Material:</strong> 100% Algodón<br>
                    <strong>Cuidados:</strong> Lavar a máquina en agua fría, no usar blanqueador, planchar a baja temperatura.
                </p>
            `;
            
            // Actualizar imágenes
            actualizarImagenesProducto();
            
            // Actualizar disponibilidad
            actualizarDisponibilidad();
            
            // Ocultar loading
            document.getElementById("loadingImage").style.display = "none";
        }

        // Actualizar imágenes del producto
        function actualizarImagenesProducto() {
            const mainContainer = document.getElementById("mainImageContainer");
            const thumbnailContainer = document.getElementById("thumbnailContainer");
            
            // URL de imagen principal
            let mainImageUrl = productoActual.imagen_url;
            if (mainImageUrl && !mainImageUrl.startsWith('http')) {
                mainImageUrl = 'http://localhost:3000' + mainImageUrl;
            }
            
            // Imagen principal
            mainContainer.innerHTML = `
                <img src="${mainImageUrl || 'https://via.placeholder.com/600x600/eee/999?text=Sin+imagen'}" 
                     alt="${productoActual.nombre}"
                     class="img-fluid"
                     id="mainProductImage"
                     onerror="this.src='https://via.placeholder.com/600x600/eee/999?text=Sin+imagen'">
            `;
            
            // Miniaturas (en un caso real podrían ser múltiples imágenes)
            thumbnailContainer.innerHTML = `
                <div class="thumbnail-item active" onclick="cambiarImagen('${mainImageUrl || ''}')">
                    <img src="${mainImageUrl || 'https://via.placeholder.com/100x100/eee/999?text=Sin+imagen'}" 
                         alt="Vista 1"
                         onerror="this.src='https://via.placeholder.com/100x100/eee/999?text=Sin+imagen'">
                </div>
                <div class="thumbnail-item" onclick="cambiarImagen('https://via.placeholder.com/600x600/ccc/666?text=Angulo+2')">
                    <img src="https://via.placeholder.com/100x100/ccc/666?text=Angulo+2" alt="Vista 2">
                </div>
                <div class="thumbnail-item" onclick="cambiarImagen('https://via.placeholder.com/600x600/bbb/555?text=Angulo+3')">
                    <img src="https://via.placeholder.com/100x100/bbb/555?text=Angulo+3" alt="Vista 3">
                </div>
            `;
        }

        // Cambiar imagen principal
        function cambiarImagen(url) {
            const mainImage = document.getElementById("mainProductImage");
            if (mainImage && url) {
                mainImage.src = url;
                
                // Actualizar miniaturas activas
                document.querySelectorAll('.thumbnail-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.thumbnail-item').classList.add('active');
            }
        }

        // Actualizar disponibilidad del producto
        function actualizarDisponibilidad() {
            const stockBadge = document.getElementById("productStockBadge");
            const stockText = document.getElementById("productStockText");
            const addToCartBtn = document.getElementById("addToCartBtn");
            const buyNowBtn = document.getElementById("buyNowBtn");
            
            // Determinar estado del stock
            let stockClass, badgeText, textMessage, disponible;
            
            if (productoActual.stock_actual <= 0) {
                stockClass = "stock-out";
                badgeText = "Agotado";
                textMessage = "Producto temporalmente no disponible";
                disponible = false;
                maxQuantity = 0;
            } else if (productoActual.stock_bajo) {
                stockClass = "stock-low";
                badgeText = "Pocas unidades";
                textMessage = `Solo ${productoActual.stock_actual} unidades disponibles`;
                disponible = true;
                maxQuantity = Math.min(productoActual.stock_actual, 10);
            } else {
                stockClass = "stock-available";
                badgeText = "Disponible";
                textMessage = `${productoActual.stock_actual} unidades disponibles`;
                disponible = true;
                maxQuantity = Math.min(productoActual.stock_actual, 10);
            }
            
            // Actualizar badge
            stockBadge.className = `stock-badge ${stockClass}`;
            stockBadge.innerHTML = `<i class="fas fa-${disponible ? 'check' : 'times'} me-1"></i>${badgeText}`;
            
            // Actualizar texto
            stockText.textContent = textMessage;
            
            // Actualizar cantidad máxima
            document.getElementById("maxStockText").textContent = `(Máx: ${maxQuantity})`;
            
            // Actualizar botones
            if (!disponible) {
                addToCartBtn.disabled = true;
                addToCartBtn.innerHTML = '<i class="fas fa-times me-2"></i> Agotado';
                addToCartBtn.classList.remove("btn-loopme");
                addToCartBtn.classList.add("btn-secondary");
                
                buyNowBtn.disabled = true;
                buyNowBtn.innerHTML = '<i class="fas fa-times me-2"></i> No disponible';
                buyNowBtn.classList.remove("btn-loopme-outline");
                buyNowBtn.classList.add("btn-secondary");
                
                // Deshabilitar selector de cantidad
                document.getElementById("productQuantity").disabled = true;
            } else {
                addToCartBtn.disabled = false;
                addToCartBtn.innerHTML = '<i class="fas fa-cart-plus me-2"></i> Agregar al Carrito';
                addToCartBtn.classList.remove("btn-secondary");
                addToCartBtn.classList.add("btn-loopme");
                
                buyNowBtn.disabled = false;
                buyNowBtn.innerHTML = '<i class="fas fa-bolt me-2"></i> Comprar Ahora';
                buyNowBtn.classList.remove("btn-secondary");
                buyNowBtn.classList.add("btn-loopme-outline");
                
                // Habilitar selector de cantidad
                document.getElementById("productQuantity").disabled = false;
                document.getElementById("productQuantity").max = maxQuantity;
                
                // Verificar si ya está en el carrito
                const carrito = JSON.parse(localStorage.getItem("carrito") || "[]");
                const enCarrito = carrito.some(item => item.id === productoActual.id);
                
                if (enCarrito) {
                    addToCartBtn.innerHTML = '<i class="fas fa-check me-2"></i> En el Carrito';
                    addToCartBtn.classList.remove("btn-loopme");
                    addToCartBtn.classList.add("btn-success");
                }
            }
        }

        // Incrementar cantidad
        function increaseQuantity() {
            if (currentQuantity < maxQuantity) {
                currentQuantity++;
                document.getElementById("productQuantity").value = currentQuantity;
            }
        }

        // Decrementar cantidad
        function decreaseQuantity() {
            if (currentQuantity > 1) {
                currentQuantity--;
                document.getElementById("productQuantity").value = currentQuantity;
            }
        }

        // Actualizar cantidad desde input
        document.getElementById("productQuantity").addEventListener("change", function() {
            let value = parseInt(this.value);
            
            if (isNaN(value) || value < 1) {
                value = 1;
            } else if (value > maxQuantity) {
                value = maxQuantity;
            }
            
            currentQuantity = value;
            this.value = currentQuantity;
        });

        // Cargar productos relacionados
        function cargarProductosRelacionados() {
            if (!productoActual) return;
            
            fetch("http://localhost:3000/api/products")
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.productos) {
                        // Filtrar productos relacionados (misma categoría, excluyendo el actual)
                        const relacionados = data.productos
                            .filter(p => p.id !== productoActual.id && 
                                      (p.categoria_id === productoActual.categoria_id || 
                                       Math.random() > 0.7)) // 30% de productos aleatorios
                            .slice(0, 4); // Máximo 4 productos
                        
                        relatedProducts = relacionados;
                        mostrarProductosRelacionados();
                    }
                })
                .catch(error => console.error("Error cargando productos relacionados:", error));
        }

        // Mostrar productos relacionados
        function mostrarProductosRelacionados() {
            const container = document.getElementById("relatedProductsContainer");
            
            if (relatedProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <p class="text-muted">No hay productos relacionados disponibles</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            relatedProducts.forEach(producto => {
                let imagenUrl = producto.imagen_url;
                if (imagenUrl && !imagenUrl.startsWith('http')) {
                    imagenUrl = 'http://localhost:3000' + imagenUrl;
                }
                
                html += `
                    <div class="col-lg-3 col-md-6">
                        <div class="card product-card">
                            <div class="product-img-container">
                                <img src="${imagenUrl || 'https://via.placeholder.com/300x300/eee/999?text=Sin+imagen'}" 
                                     class="product-img" 
                                     alt="${producto.nombre}">
                            </div>
                            <div class="product-info">
                                <a href="producto.html?id=${producto.id}" class="product-title">
                                    ${producto.nombre}
                                </a>
                                <span class="product-category">${producto.categoria || 'Sin categoría'}</span>
                                <div class="product-price">
                                    $${parseFloat(producto.precio).toFixed(2)}
                                </div>
                                <button class="btn btn-loopme btn-sm w-100" onclick="window.location.href='producto.html?id=${producto.id}'">
                                    <i class="fas fa-eye me-1"></i> Ver Producto
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Agregar al carrito
        function addToCart() {
            if (!productoActual || productoActual.stock_actual <= 0) {
                mostrarMensajeCarrito("Producto no disponible", "danger");
                return;
            }
            
            const cantidad = parseInt(document.getElementById("productQuantity").value);
            if (cantidad < 1 || cantidad > maxQuantity) {
                mostrarMensajeCarrito(`Cantidad inválida. Máximo: ${maxQuantity}`, "warning");
                return;
            }
            
            // Obtener carrito actual
            let carrito = JSON.parse(localStorage.getItem("carrito") || "[]");
            
            // Buscar si el producto ya está en el carrito
            const index = carrito.findIndex(item => item.id === productoActual.id);
            
            if (index >= 0) {
                // Actualizar cantidad si ya existe
                const nuevaCantidad = carrito[index].cantidad + cantidad;
                if (nuevaCantidad > maxQuantity) {
                    mostrarMensajeCarrito(`No puedes agregar más de ${maxQuantity} unidades de este producto`, "warning");
                    return;
                }
                carrito[index].cantidad = nuevaCantidad;
            } else {
                // Agregar nuevo producto al carrito
                carrito.push({
                    id: productoActual.id,
                    nombre: productoActual.nombre,
                    precio: productoActual.precio,
                    imagen: productoActual.imagen_url,
                    categoria: productoActual.categoria,
                    cantidad: cantidad,
                    stock: productoActual.stock_actual
                });
            }
            
            // Guardar en localStorage
            localStorage.setItem("carrito", JSON.stringify(carrito));
            
            // Actualizar interfaz
            actualizarContadorCarrito();
            actualizarDisponibilidad(); // Para cambiar el botón a "En el Carrito"
            
            // Mostrar mensaje de éxito
            mostrarMensajeCarrito(`¡${cantidad} ${cantidad === 1 ? 'unidad' : 'unidades'} de "${productoActual.nombre}" agregada${cantidad === 1 ? '' : 's'} al carrito!`, "success");
        }

        // Comprar ahora (ir directamente al checkout)
        function buyNow() {
            if (!productoActual || productoActual.stock_actual <= 0) {
                mostrarMensajeCarrito("Producto no disponible", "danger");
                return;
            }
            
            const cantidad = parseInt(document.getElementById("productQuantity").value);
            if (cantidad < 1 || cantidad > maxQuantity) {
                mostrarMensajeCarrito(`Cantidad inválida. Máximo: ${maxQuantity}`, "warning");
                return;
            }
            
            // Crear un carrito temporal solo con este producto
            const carritoComprarAhora = [{
                id: productoActual.id,
                nombre: productoActual.nombre,
                precio: productoActual.precio,
                imagen: productoActual.imagen_url,
                categoria: productoActual.categoria,
                cantidad: cantidad,
                stock: productoActual.stock_actual,
                comprarAhora: true // Marcar como compra inmediata
            }];
            
            // Guardar en localStorage temporalmente
            localStorage.setItem("comprar_ahora", JSON.stringify(carritoComprarAhora));
            
            // Redirigir al checkout
            window.location.href = "checkout.html?comprar_ahora=true";
        }

        // Mostrar mensaje del carrito
        function mostrarMensajeCarrito(mensaje, tipo) {
            const cartMessage = document.getElementById("cartMessage");
            
            cartMessage.textContent = mensaje;
            cartMessage.className = `alert alert-${tipo} mt-3`;
            cartMessage.classList.remove("d-none");
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                cartMessage.classList.add("d-none");
            }, 3000);
        }

        // Actualizar contador del carrito
        function actualizarContadorCarrito() {
            const carrito = JSON.parse(localStorage.getItem("carrito") || "[]");
            cartCount = carrito.reduce((total, item) => total + item.cantidad, 0);
            document.getElementById("cartCount").textContent = cartCount;
        }

        // Mostrar error
        function mostrarError(mensaje) {
            const container = document.querySelector(".product-detail-container");
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h3>${mensaje}</h3>
                    <p class="text-muted">Lo sentimos, no pudimos cargar el producto solicitado.</p>
                    <a href="tienda.html" class="btn btn-loopme mt-3">
                        <i class="fas fa-arrow-left me-2"></i> Volver a la tienda
                    </a>
                </div>
            `;
        }

        // Inicializar cantidad
        document.getElementById("productQuantity").addEventListener("input", function() {
            currentQuantity = parseInt(this.value) || 1;
        });
    </script>
</body>
</html>
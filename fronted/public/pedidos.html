<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos - LoopMe</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Estilos LoopMe -->
    <link rel="stylesheet" href="css/public.css">
    <style>
        .badge-pendiente {
            background-color: #ffc107;
            color: #000;
        }

        .badge-pagado {
            background-color: #17a2b8;
            color: #fff;
        }

        .badge-enviado {
            background-color: #007bff;
            color: #fff;
        }

        .badge-entregado {
            background-color: #28a745;
            color: #fff;
        }

        .badge-cancelado {
            background-color: #dc3545;
            color: #fff;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-loopme">
        <div class="container">
            <a class="navbar-brand navbar-brand-loopme" href="index.html">
                <i class="fas fa-tshirt"></i> LoopMe
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarLoopMe">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarLoopMe">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme" href="index.html">
                            <i class="fas fa-home"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme" href="tienda.html">
                            <i class="fas fa-store"></i> Tienda
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme active" href="pedidos.html">
                            <i class="fas fa-clipboard-list"></i> Mis Pedidos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-loopme" href="#" id="loginLink">
                            <i class="fas fa-user"></i> Mi Cuenta
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="bg-light py-5 mb-5">
        <div class="container text-center">
            <h1 class="display-4 fw-bold animate-up">Mis Pedidos</h1>
            <p class="lead text-muted animate-up">Revisa el estado de tus compras y envíos</p>
        </div>
    </div>

    <!-- Contenido -->
    <div class="container mb-5">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th># Pedido</th>
                                        <th>Fecha</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPedidos">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">Cargando tus pedidos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="loopme-footer mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="footer-logo">
                        <i class="fas fa-tshirt me-2"></i>LoopMe
                    </div>
                    <p>Tu tienda de moda online con las mejores prendas y accesorios para hombre y mujer.</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-pinterest"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 mb-4">
                    <div class="footer-links">
                        <h5>Navegación</h5>
                        <ul>
                            <li><a href="index.html">Inicio</a></li>
                            <li><a href="tienda.html">Tienda</a></li>
                            <li><a href="carrito.html">Carrito</a></li>
                            <li><a href="pedidos.html">Mis Pedidos</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 mb-4">
                    <div class="footer-links">
                        <h5>Información</h5>
                        <ul>
                            <li><a href="#">Sobre Nosotros</a></li>
                            <li><a href="#">Contacto</a></li>
                            <li><a href="#" data-bs-toggle="modal" data-bs-target="#policyModal">Políticas y Términos</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 mb-4">
                    <div class="footer-links">
                        <h5>Contacto</h5>
                        <ul>
                            <li><i class="fas fa-map-marker-alt me-2"></i> Caracas, Venezuela</li>
                            <li><i class="fas fa-phone me-2"></i> +58 412-1234567</li>
                            <li><i class="fas fa-envelope me-2"></i> info@loopme.com</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 LoopMe Tienda de Ropa. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal de Políticas y Términos -->
    <div class="modal fade" id="policyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-contract me-2"></i>Términos, Condiciones y Políticas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h4>1. Términos de Uso</h4>
                    <p>Bienvenido a LoopMe. Al acceder y utilizar nuestro sitio web, aceptas cumplir con los siguientes términos y condiciones. Si no estás de acuerdo con alguna parte, te pedimos no utilizar nuestros servicios.</p>
                    
                    <h4>2. Políticas de Envío</h4>
                    <p>Nos esforzamos por realizar envíos a toda Venezuela. Los tiempos de entrega varían según la ubicación, generalmente entre 2 a 5 días hábiles. LoopMe no se hace responsable por retrasos causados por las empresas de encomienda.</p>
                    
                    <h4>3. Políticas de Devolución</h4>
                    <p>Aceptamos devoluciones dentro de los 7 días posteriores a la recepción del producto, siempre que la prenda esté en perfectas condiciones, con sus etiquetas originales y sin uso. Los costos de envío por devolución corren por cuenta del cliente, salvo errores de fábrica.</p>
                    
                    <h4>4. Privacidad y Datos</h4>
                    <p>Tu privacidad es importante. Tus datos personales serán utilizados únicamente para procesar tus pedidos y mejorar tu experiencia de compra. No compartimos tu información con terceros no autorizados.</p>
                    
                    <div class="form-check mt-4 p-3 bg-light rounded border">
                        <input class="form-check-input" type="checkbox" id="acceptPolicy">
                        <label class="form-check-label" for="acceptPolicy">
                            He leído y acepto los términos, condiciones y políticas de privacidad de LoopMe.
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnAcceptPolicy" disabled onclick="acceptPolicyAction()">Aceptar y Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('acceptPolicy');
            const btn = document.getElementById('btnAcceptPolicy');
            
            if(checkbox && btn) {
                checkbox.addEventListener('change', function() {
                    btn.disabled = !this.checked;
                });
            }
        });

        function acceptPolicyAction() {
            const modalEl = document.getElementById('policyModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            localStorage.setItem('termsAccepted', 'true');
        }
    </script>

    <!-- Modal de Detalles de Pedido -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-loopme text-white">
                    <h5 class="modal-title" id="orderModalTitle">Detalle del Pedido #0</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = null;

        document.addEventListener('DOMContentLoaded', () => {
            verificarAutenticacion();
            cargarMisPedidos();
        });

        function verificarAutenticacion() {
            token = localStorage.getItem("cliente_token");
            const clienteInfo = JSON.parse(localStorage.getItem("cliente_info") || '{}');
            const loginLink = document.getElementById("loginLink");

            if (!token) {
                // Si no hay token, redirigir a login o mostrar opción
                document.getElementById('tablaPedidos').innerHTML = `
                    <tr><td colspan="5" class="text-center py-4">
                        Debes <a href="login-cliente.html">iniciar sesión</a> para ver tus pedidos.
                    </td></tr>
                `;
                loginLink.href = "login-cliente.html";
                return;
            }

            // Configurar menú usuario
            loginLink.innerHTML = `<i class="fas fa-user me-1"></i> ${clienteInfo.nombre?.split(' ')[0] || 'Cliente'}`;
            loginLink.href = "#";
            loginLink.addEventListener('click', (e) => {
                e.preventDefault();
                mostrarMenuUsuario(clienteInfo);
            });
        }

        function cargarMisPedidos() {
            if (!token) return;

            fetch("/api/orders/my-orders", {
                headers: { "Authorization": `Bearer ${token}` }
            })
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById("tablaPedidos");
                    if (!data.success || !data.pedidos || data.pedidos.length === 0) {
                        tbody.innerHTML = `
                        <tr><td colspan="5" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-shopping-bag fa-3x mb-3"></i>
                                <p>Aún no has realizado compras.</p>
                                <a href="tienda.html" class="btn btn-loopme">Ir a la Tienda</a>
                            </div>
                        </td></tr>
                    `;
                        return;
                    }

                    let html = "";
                    data.pedidos.forEach(p => {
                        const fecha = new Date(p.fecha_pedido).toLocaleDateString();
                        let badgeClass = "badge-secondary";
                        let estadoTexto = p.estado;

                        switch (p.estado) {
                            case 'Pendiente': badgeClass = "badge-pendiente"; break;
                            case 'Pagado': badgeClass = "badge-pagado"; break;
                            case 'Enviado': badgeClass = "badge-enviado"; break;
                            case 'Entregado': badgeClass = "badge-entregado"; break;
                            case 'Cancelado': badgeClass = "badge-cancelado"; break;
                        }

                        // Acciones
                        let acciones = `<button class="btn btn-outline-primary btn-sm me-2" onclick="verDetalle(${p.id})">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>`;

                        if (p.estado === 'Enviado') {
                            acciones += `<button class="btn btn-success btn-sm" onclick="confirmarRecepcion(${p.id})">
                                        <i class="fas fa-box-open"></i> Recibí mi envío
                                      </button>`;
                        }

                        html += `
                        <tr>
                            <td>#${p.id}</td>
                            <td>${fecha}</td>
                            <td>$${parseFloat(p.total).toFixed(2)}</td>
                            <td><span class="badge ${badgeClass}">${estadoTexto}</span></td>
                            <td>${acciones}</td>
                        </tr>
                    `;
                    });
                    tbody.innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById("tablaPedidos").innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar pedidos.</td></tr>';
                });
        }

        function confirmarRecepcion(id) {
            Swal.fire({
                title: '¿Confirmar recepción?',
                text: "¿Has recibido tu pedido correctamente?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, lo recibí',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Procesando...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    fetch(`/api/orders/${id}/estado`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ estado: 'Entregado' })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    title: '¡Confirmado!',
                                    text: '¡Gracias por confirmar! Esperamos que disfrutes tu compra.',
                                    icon: 'success',
                                    confirmButtonColor: '#6f42c1'
                                });
                                cargarMisPedidos();
                            } else {
                                Swal.fire('Error', data.message || 'No se pudo actualizar', 'error');
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            Swal.fire('Error de conexión', 'No se pudo contactar con el servidor', 'error');
                        });
                }
            });
        }

        const detailModal = new bootstrap.Modal(document.getElementById('orderDetailModal'));

        function verDetalle(id) {
            document.getElementById('orderModalTitle').innerText = `Detalle del Pedido #${id}`;
            const body = document.getElementById('orderDetailBody');
            body.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            `;
            
            detailModal.show();

            fetch(`/api/orders/${id}`, {
                headers: { "Authorization": `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const p = data.pedido;
                    const detalles = data.detalles;
                    
                    let tableRows = '';
                    detalles.forEach(d => {
                        tableRows += `
                            <tr>
                                <td>${d.producto_nombre}</td>
                                <td>${d.cantidad}</td>
                                <td>$${parseFloat(d.precio_unitario).toFixed(2)}</td>
                                <td class="text-end">$${parseFloat(d.subtotal).toFixed(2)}</td>
                            </tr>
                        `;
                    });

                    body.innerHTML = `
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted text-uppercase small fw-bold">Información del Cliente</h6>
                                <p class="mb-1"><strong>${p.cliente_nombre} ${p.cliente_apellido || ''}</strong></p>
                                <p class="mb-0 text-muted">${p.cliente_email}</p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <h6 class="text-muted text-uppercase small fw-bold">Fecha del Pedido</h6>
                                <p class="mb-0">${new Date(p.fecha_pedido).toLocaleString()}</p>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cant.</th>
                                        <th>Precio</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3" class="text-end">Total</th>
                                        <th class="text-end text-primary fs-5">$${parseFloat(p.total).toFixed(2)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                } else {
                    body.innerHTML = `<div class="alert alert-danger">${data.message || 'Error al cargar detalles'}</div>`;
                }
            })
            .catch(err => {
                console.error(err);
                body.innerHTML = `<div class="alert alert-danger">Error de conexión al servidor</div>`;
            });
        }

        // Menú desplegable reutilizado
        function mostrarMenuUsuario(clienteInfo) {
            // Logic similar to other pages
            const menuHTML = `
                <div class="dropdown-menu show" style="position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate(0px, 40px);">
                    <div class="dropdown-header">
                        <strong>${clienteInfo.nombre}</strong>
                        <p class="mb-0 text-muted small">${clienteInfo.email}</p>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="pedidos.html">
                        <i class="fas fa-clipboard-list me-2"></i>Mis Pedidos
                    </a>
                    <a class="dropdown-item" href="favoritos.html">
                        <i class="fas fa-heart me-2"></i>Favoritos
                    </a>
                    <a class="dropdown-item" href="perfil.html">
                        <i class="fas fa-user-edit me-2"></i>Mi Perfil
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-danger" href="#" onclick="logoutCliente()">
                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                    </a>
                </div>
            `;

            const loginLink = document.getElementById("loginLink");
            let dropdownMenu = loginLink.nextElementSibling;

            if (!dropdownMenu || !dropdownMenu.classList.contains("dropdown-menu")) {
                dropdownMenu = document.createElement("div");
                dropdownMenu.className = "dropdown-menu";
                loginLink.parentElement.appendChild(dropdownMenu);
            }

            dropdownMenu.innerHTML = menuHTML;
            dropdownMenu.classList.add("show");

            document.addEventListener('click', function closeMenu(e) {
                if (!loginLink.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove("show");
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        function logoutCliente() {
            Swal.fire({
                title: '¿Cerrar sesión?',
                text: "¿Estás seguro de que deseas salir?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#6f42c1',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cerrar sesión',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem("cliente_token");
                    localStorage.removeItem("cliente_info");
                    window.location.href = "tienda.html";
                }
            });
        }
    </script>
</body>

</html>